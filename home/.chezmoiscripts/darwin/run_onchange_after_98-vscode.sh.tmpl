#!/usr/bin/env bash

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   @author         :   Chris Burnham
#   @file           :
#   @description    :
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# --------------------------------------------------------------------------------------------------
#   @description    :   Load script libraries
# --------------------------------------------------------------------------------------------------
{{ template "script-library" }}
# ==================================================================================================

# --------------------------------------------------------------------------------------------------
#   @description    :   Pre-flight
# --------------------------------------------------------------------------------------------------
info "[ðŸ†š         VS Code] Setting log level to debug."
LOG_LEVEL=7
debug "[ðŸ†š         VS Code] Verifying installation."

if ! check_macos_app "Code.app"; then
  info "[ðŸ†š         VS Code] Application is not installed."
  exit 0

else
  debug "[ðŸ†š         VS Code] Application is installed."

  if [ "${TERM_PROGRAM}" == "vscode" ]; then
    error "[ðŸ†š         VS Code] VS Code is unable to be configured while running. Re-run \`chezmoi apply\` from another terminal, such as Terminal.app."
    exit 0
  fi

  info "[ðŸ†š         VS Code] Closing VS Code, to prevent it from overriding changes."
  osascript -e 'tell application "Code" to quit'
  killall "cfprefsd"

fi
# ==================================================================================================

# --------------------------------------------------------------------------------------------------
#   @description    :   VS Code | Extensions
# --------------------------------------------------------------------------------------------------
extensions_list=(
  "albert.tabout"
  "eamodio.gitlens"
  "editorconfig.editorconfig"
  "esbenp.prettier-vscode"
  "gruntfuggly.todo-tree"
  "hashicorp.terraform"
  "mikestead.dotenv"
  "ms-azuretools.vscode-docker"
  "ms-python.python"
  "ms-python.vscode-pylance"
  "ms-vscode-remote.remote-containers"
  "ms-vscode-remote.remote-ssh"
  "ms-vscode-remote.remote-ssh-edit"
  "oderwat.indent-rainbow"
  "raillyhugo.one-hunter"
  "redhat.vscode-yaml"
  "samuelcolvin.jinjahtml"
  "signageos.signageos-vscode-sops"
  "tamasfe.even-better-toml"
  "tomoki1207.selectline-statusbar"
  "usernamehw.errorlens"
)

function get_vscode_extension_state() {
  local extension="$1"
  code --list-extensions 2>/dev/null | grep "${extension}" >/dev/null
}

for extension in "${extensions_list[@]}"; do

  if ! get_vscode_extension_state "${extension}"; then
    debug "[ðŸ†š         VS Code] Installing extension: ${extension}."
    code --install-extension "${extension}" &> /dev/null

  else
    debug "[ðŸ†š         VS Code] Extension already installed: ${extension}."

  fi

done
# ==================================================================================================

info "[ðŸ†š         VS Code] Configuration complete."
