#!/usr/bin/env bash

# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
#   @author         :   Chris Burnham
#   @file           :
#   @description    :
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# --------------------------------------------------------------------------------------------------
#   @description    :   Load script libraries
# --------------------------------------------------------------------------------------------------
{{ template "script-library" }}
# ==================================================================================================

# --------------------------------------------------------------------------------------------------
#   @description    :   Pre-flight
# --------------------------------------------------------------------------------------------------
LOG_CATEGORY="Homebrew"
LOG_CATEGORY_ICON="üç∫"
info "Setting log level to debug."
LOG_LEVEL=5

debug "Verifying installation"

if check_binary brew; then
  debug "Application is installed"
  exit 0

else
  info "Application is not installed"

fi
# ==================================================================================================

# --------------------------------------------------------------------------------------------------
#   @description    :   Install Homebrew
# --------------------------------------------------------------------------------------------------
info "Installing Homebrew, The Missing Package Manager for macOS (or Linux). Follow the instructions!"

# info "Administrator password needed to install Homebrew"
{{ template "script-sudo" }}

cpu_brand_string="$(sysctl -n machdep.cpu.brand_string)"
if [[ "${cpu_brand_string}" =~ "Apple" ]]; then
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"

elif [[ "${cpu_brand_string}" =~ "Intel" ]]; then
  NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

else
  fatal "Unable to install. ${cpu_brand_string} is an unsupported CPU type"

fi
# ==================================================================================================

# --------------------------------------------------------------------------------------------------
#   @description    :   Install mas
# --------------------------------------------------------------------------------------------------
LOG_CATEGORY="mas"
LOG_CATEGORY_ICON="üß∫"

{{ if eq .osid "darwin" }}
debug "Verifying installation"

if check_binary mas; then
  debug "Application is installed"
  exit 0

else
  info "Application is not installed"
  info "Installing mas, Mac Apple Store CLI"
  brew tap "mas-cli/tap"
  brew install "mas-cli/tap/mas"

fi

{{ else }}
debug "Skipping. Does not apply to this operating system"
exit 0

{{ end }}
# ==================================================================================================
